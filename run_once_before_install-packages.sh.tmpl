#!/bin/sh

CONFIG_PATH="{{ .chezmoi.homeDir }}/.config/chezmoi/chezmoi.toml"
if [ ! -e "$CONFIG_PATH" ]; then
  echo "$CONFIG_PATH not exist" >&2
  exit 1
fi

if [ -n "${CI:-}" ]; then
  echo "skip startup (because: CI)"
  exit 0
fi

{{- if and (eq .chezmoi.os "darwin") (eq .chezmoi.arch "arm64") }}

missing=0

if ! command -v brew >/dev/null 2>&1; then
  echo "ERROR: Homebrew (brew) is not installed." >&2
  missing=1
fi

if ! command -v fish >/dev/null 2>&1; then
  echo "ERROR: fish shell is not installed." >&2
  missing=1
fi

current_shell="${SHELL:-}"
if [ "$(basename "$current_shell")" != "fish" ]; then
  echo "ERROR: Default shell is not fish. Current: $current_shell" >&2
  missing=1
fi

if ! command -v mise >/dev/null 2>&1; then
  echo "ERROR: mise is not installed." >&2
  missing=1
fi

if [ "$missing" -ne 0 ]; then
  exit 1
fi

echo "OK: All requirements satisfied for macos"

{{ if eq .brew_install "true" -}}

brew install \
  git wget \
  gcc cmake ninja pkg-config \
  fd fzf

{{ end -}}

echo "OK: before setup install completed"

{{ if eq .neovim_install "true" -}}

echo "install neovim"

rm ./nvim-macos-arm64.tar.gz 2>/dev/null
rm ~/.local/bin/nvim 2>/dev/null
rm -rf ~/.local/share/nvim-macos-arm64 2>/dev/null

curl -LO https://github.com/neovim/neovim/releases/download/{{ .neovim_version }}/nvim-macos-arm64.tar.gz
xattr -c ./nvim-macos-arm64.tar.gz
tar xzvf ./nvim-macos-arm64.tar.gz

rm ./nvim-macos-arm64.tar.gz

mkdir -p ~/.local/bin
mkdir -p ~/.local/share

mv ./nvim-macos-arm64 ~/.local/share/.
ln -s ~/.local/share/nvim-macos-arm64/bin/nvim ~/.local/bin/nvim

{{ end -}}

{{ if eq .font_install "true" }}

curl -LO https://github.com/yuru7/bizin-gothic/releases/download/v0.0.4/BizinGothicNF_v0.0.4.zip
unzip BizinGothicNF_v0.0.4.zip
mv ./BizinGothicNF_v0.0.4/BizinGothicNF-Regular.ttf ~/Library/Fonts/.
rm BizinGothicNF_v0.0.4.zip
rm -rf BizinGothicNF_v0.0.4

{{ end -}}

echo "complete"

exit 0

{{- else if and (eq .chezmoi.os "linux") (eq .chezmoi.osRelease.id "linuxmint") }}

missing=0

if ! command -v brew >/dev/null 2>&1; then
  echo "ERROR: Homebrew (brew) is not installed." >&2
  missing=1
fi

if ! command -v fish >/dev/null 2>&1; then
  echo "ERROR: fish shell is not installed." >&2
  missing=1
fi

current_shell="${SHELL:-}"
if [ "$(basename "$current_shell")" != "fish" ]; then
  echo "ERROR: Default shell is not fish. Current: $current_shell" >&2
  missing=1
fi

if ! command -v mise >/dev/null 2>&1; then
  echo "ERROR: mise is not installed." >&2
  missing=1
fi

if [ "$missing" -ne 0 ]; then
  exit 1
fi

echo "OK: All requirements satisfied for Linux."

{{ if eq .apt_install "true" }}

sudo apt-get update

sudo apt-get install -y \
  build-essential \
  curl \
  git \
  ca-certificates \
  zlib1g-dev \
  libssl-dev \
  libreadline-dev \
  libyaml-dev \
  libffi-dev \
  libgdbm-dev \
  libncurses5-dev libncursesw5-dev \
  libsqlite3-dev sqlite3 \
  libxml2-dev libxslt1-dev \
  autoconf bison \
  fzf xclip

{{ end -}}



echo "OK: before setup install completed"

{{ if eq .neovim_install "true" -}}

echo "install neovim"

curl -LO https://github.com/neovim/neovim/releases/download/{{ .neovim_version }}/nvim-linux-x86_64.tar.gz
xattr -c ./nvim-linux-x86_64.tar.gz
tar xzvf ./nvim-linux-x86_64.tar.gz

rm ./nvim-linux-x86_64.tar.gz

mkdir -p ~/.local/bin
mkdir -p ~/.local/share

mv ./nvim-linux-x86_64 ~/.local/share/.
ln -s ~/.local/share/nvim-linux-x86_64/bin/nvim ~/.local/bin/nvim

{{ end -}}

{{ if eq .font_install "true" }}

curl -LO https://github.com/yuru7/bizin-gothic/releases/download/v0.0.4/BizinGothicNF_v0.0.4.zip
unzip BizinGothicNF_v0.0.4.zip
mkdir -p ~/.local/share/fonts
mv ./BizinGothicNF_v0.0.4/BizinGothicNF-Regular.ttf ~/.local/share/fonts/.
rm BizinGothicNF_v0.0.4.zip
rm -rf BizinGothicNF_v0.0.4

{{ end -}}

exit 0

{{ else }}
# Other OS
echo "ERROR: No environment validation required for this OS."
exit 1
{{ end }}
